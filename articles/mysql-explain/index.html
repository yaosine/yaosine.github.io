<!DOCTYPE HTML>
<html class="no-js" lang="zh-CN">
<head>
    <!--[if lte IE 9]>
<meta http-equiv="refresh" content="0;url=https://yaosine.github.io/warn.html">
<![endif]-->
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<meta http-equiv="mobile-agent" content="format=html5; url=https://yaosine.github.io">
<meta name="author" content="Yaosine">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/SimpleStyle.min.css">

<link rel="shortcut icon" href="/images/favicon.png">


<title>mysql性能优化 - Web架构之路 - The way of Web Architecture</title>

<meta name="keywords" content="">

<meta name="description " content="当发现程序运行比较慢的时候，首先排除物力资源问题之后，就将注意力转向mysq数据库。">
</head>
<body>
<div id="nav">
    <nav class="nav-menu">
        <a class="site-name current" href="/" title="WA">WA</a>
        <a class="site-index current" href="/"><i class="fa fa-home"></i><span>首页</span></a>
        <a href="/archives" title="归档"><i class="fa fa-area-chart "></i><span>归档</span></a>
        <a href="/tags" title="标签"><i class="fa fa-tags"></i><span>标签</span></a>
        <!-- custom single page of menus -->
        
        
        <a href="/categories/PHP" title="PHP">
            <i class="fa fa-product-hunt"></i>
            <span>PHP</span>
        </a>
        
        
        <a href="/categories/MySQL" title="MySQL">
            <i class="fa fa-maxcdn"></i>
            <span>MySQL</span>
        </a>
        
        
        <a href="/categories/Linux" title="Linux">
            <i class="fa fa-linux"></i>
            <span>Linux</span>
        </a>
        
        
        <a href="/categories/Nginx" title="Nginx">
            <i class="fa fa-server"></i>
            <span>Nginx</span>
        </a>
        
        
        <a href="/categories/NoSQL" title="NoSQL">
            <i class="fa fa-registered"></i>
            <span>NoSQL</span>
        </a>
        
        
        <a href="/categories/Queue" title="Queue">
            <i class="fa fa-quora"></i>
            <span>Queue</span>
        </a>
        
        
        <a href="/categories/ES" title="ES">
            <i class="fa fa-etsy"></i>
            <span>ES</span>
        </a>
        
        
        <a href="/categories/GO" title="GO">
            <i class="fa fa-google"></i>
            <span>GO</span>
        </a>
        
    </nav>
</div>
<div class="nav-user">
    <!--<a class="btn-search" href="#"><i class="fa fa-search"></i></a>-->
    <a class="btn-read-mode" href="#"><i class="fa fa-sun-o"></i></a>
    <!--<a class="btn-sns-qr" href="javascript:"><i class="fa fa-telegram"></i></a>-->
</div>

<div id="wrapper" class="clearfix">
    <div id="body">
        <div class="main" id="main">
            <div id="cover">
    <div class="cover-img"></div>
    <div class="cover-info">
        
        <h1 class="cover-siteName">Web架构之路</h1>
        <h3 class="cover-siteTitle">The way of Web Architecture</h3>
        <p class="cover-siteDesc">一个关注Web架构技术的IT博客</p>
        <div class="cover-sns">
            
            <div class="btn btn-github">
                <a href="https://github.com/yaosine" target="_blank" title="github" ref="friend">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            
        </div>
    </div>
</div>
            <div class="page-title">
    <ul>
        <li><a href="/">Home</a></li>
        
            
                <li class="">
                    <a href="/categories/PHP" data-name="PHP">PHP</a>
                </li>
            
                <li class="">
                    <a href="/categories/Linux" data-name="Linux">Linux</a>
                </li>
            
                <li class="active">
                    <a href="/categories/MySQL" data-name="MySQL">MySQL</a>
                </li>
            
                <li class="">
                    <a href="/categories/NoSQL" data-name="NoSQL">NoSQL</a>
                </li>
            
                <li class="">
                    <a href="/categories/Nginx" data-name="Nginx">Nginx</a>
                </li>
            
                <li class="">
                    <a href="/categories/Queue" data-name="Queue">Queue</a>
                </li>
            
                <li class="">
                    <a href="/categories/ES" data-name="ES">ES</a>
                </li>
            
                <li class="">
                    <a href="/categories/GO" data-name="GO">GO</a>
                </li>
            
        
        <script>
(function (window) {
    window.INSIGHT_CONFIG = {
        ROOT_URL: '/',
        CONTENT_URL: ''
    };
})(window);
</script>
<!--
<li class="page-search">
    <form id="search" class="search-form">
        <label for="s" class="sr-only">请输入关键字</label>
        <input class="search-field" type="text" name="s" class="text" placeholder="请输入关键字" />
        <button type="submit" class="search-form-submit" title="搜索"><i class="fa fa-search"></i></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        //CONTENT_URL: '/content.json',
        CONTENT_URL: '',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
</li>
-->
    </ul>
</div>
<div class="main-inner">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <div class="post-header">
            <!--
            <div class="post-author clearfix">
                <a class="avatar fleft" href="" target="_blank">
                    <img width="48" src="" alt="avatar"/>
                </a>
                <p><span class="label">作者</span>
                    <a href="" target="_blank"></a>
                    <span title="最后编辑于2015-10-13">2015-10-13</span>
                </p>
                <p></p>
            </div>
            -->
            <h2 class="post-title">MySQL性能优化</h2>
            <div class="post-meta">
                本文发布于：2015-10-13，总共3761个字<!--，您是第<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>位看到它的小伙伴-->
            </div>
        </div>
        <div class="post-content markdown-body">
            <h2 id="发现问题"><a href="#发现问题" class="headerlink" title="发现问题"></a>发现问题</h2><p>当发现程序运行比较慢的时候，首先排除物力资源问题之后，就将注意力转向mysq数据库：</p>
<p>1、首先确定运行慢的sql语句：</p>
<blockquote>
<p>mysql&gt; show full processlist;</p>
</blockquote>
<p>2、确认低效的查询：</p>
<p>多次执行第一步发现time耗费大的sql语句。查看耗费的时间。</p>
<p>3、分析性能:</p>
<p>为sql生成一个执行计划query Execution plan</p>
<blockquote>
<p>mysql&gt; explain select * from tbal_name where …;</p>
</blockquote>
<p>4、查看创建表的语句：</p>
<blockquote>
<p>show create table table_name \G;</p>
</blockquote>
<p>5、查看表的状态：</p>
<blockquote>
<p>show table status like ‘table_name’ \G;</p>
</blockquote>
<h2 id="分析命令"><a href="#分析命令" class="headerlink" title="分析命令"></a>分析命令</h2><p>总结一些分析的命令：</p>
<ul>
<li>1、explain：解释sql的执行计划，后边的sql不执行</li>
<li>2、explain partitions ：用于查看存在分区的表的执行计划</li>
<li>3、explain extended：–书上说存在filtered列，但是检查后没有发现这一列，待验证</li>
<li>4、show warnings:</li>
<li>5、show create table:查看表的详细的创建语句，便于用户对表进行优化</li>
<li>6、show indexes :产看表的所有索引，show indexes from table_name，同样也可以从information_schema.statistics表中获得同样的信息。cardinality列很重要，表示数据量。</li>
<li>7、show tables status: 查看数据库表的底层大小以及表结构，同样可以从information_schema.tables表中获得底层表的信息。</li>
<li>8、show [global|session]status:可以查看mysql服务器当前内部状态信息。可以帮助却行mysql服务器的负载的各种指标。默认是session。同information_schema.global_status和information_schema.session_status</li>
<li>9、show [global|session] variables ：查看当前mysql系统变量的值，其中一些值能影响到sql语句的执行方式。同information_schema.global_variables和information_schema.session_variables;</li>
<li>10、information_schema:包含的表的数量和mysql的版本有关系。</li>
</ul>
<h2 id="explain"><a href="#explain" class="headerlink" title="explain"></a>explain</h2><p><strong>1 使用explain语句查看分析结果</strong></p>
<blockquote>
<p>explain select * from test1 where id=1;</p>
</blockquote>
<p>会出现：</p>
<blockquote>
<p>id  selecttype  table  type possible_keys  key key_len  ref rows  extra各列</p>
</blockquote>
<p>其中，</p>
<pre><code>type=const表示通过索引一次就找到了，
key=primary的话，表示使用了主键 
type=all,表示为全表扫描，
key=null表示没用到索引；
type=ref,因为这时认为是多个匹配行，在联合查询中，一般为REF
</code></pre><p><strong>2 MYSQL中的组合索引</strong></p>
<p>假设表有id,key1,key2,key3,把三者形成一个组合索引，如：</p>
<pre><code>where key1=....
where key1=1 and key2=2
where key1=3 and key3=3 and key2=2
</code></pre><p>根据最左原则，这些都是可以使用索引的哦<br>如</p>
<pre><code>from test where key1=1 order by key3
</code></pre><p>用explain分析的话，只用到了normal_key索引，但只对where子句起作用，而后面的order by需要排序</p>
<p><strong>3 使用慢查询分析</strong></p>
<p>在my.ini中：</p>
<pre><code>long_query_time=1
log-slow-queries=d:\mysql5\logs\mysqlslow.log
</code></pre><p>把超过1秒的记录在慢查询日志中<br>可以用mysqlsla来分析之。也可以在mysqlreport中，有如DMS 分别分析了select ,update,insert,delete,replace等所占的百份比</p>
<p><strong>4 MYISAM和INNODB的锁定</strong></p>
<p>myisam中，注意是表锁来的，比如在多个UPDATE操作后，再SELECT时，会发现SELECT操作被锁定了，必须等所有UPDATE操作完毕后，再能SELECT<br>innodb的话则不同了，用的是行锁，不存在上面问题。</p>
<p><strong>5 MYSQL的事务配置项</strong></p>
<blockquote>
<p>innodb_flush_log_at_trx_commit=1</p>
</blockquote>
<p>表示事务提交时立即把事务日志写入磁盘，同时数据和索引也更新</p>
<blockquote>
<p>innodb_flush_log_at_trx_commit=0</p>
</blockquote>
<p>事务提交时，不立即把事务日志写入磁盘，每隔1秒写一次</p>
<blockquote>
<p>innodb_flush_log_at_trx_commit=2</p>
</blockquote>
<p>事务提交时，立即写入磁盘文件（这里只是写入到内核缓冲区，但不立即刷新到磁盘，而是每隔1秒刷新到盘，同时更新数据和索引 </p>
<h2 id="explain用法"><a href="#explain用法" class="headerlink" title="explain用法"></a>explain用法</h2><blockquote>
<p>EXPLAIN tbl_name</p>
</blockquote>
<p>或：</p>
<blockquote>
<p>EXPLAIN [EXTENDED] SELECT select_options</p>
</blockquote>
<p>前者可以得出一个表的字段结构等等，后者主要是给出相关的一些索引信息，而今天要讲述的重点是后者。</p>
<p>举例</p>
<pre><code>mysql&gt; explain select * from event;
+—-+————-+——-+——+—————+——+———+——+——+——-+
| id | select_type | table | type | possible_keys | key | key_len | ref | rows | Extra |
+—-+————-+——-+——+—————+——+———+——+——+——-+
| 1 | SIMPLE | event | ALL | NULL | NULL | NULL | NULL | 13 | |
+—-+————-+——-+——+—————+——+———+——+——+——-+
1 row in set (0.00 sec)
</code></pre><p><strong>各个属性的含义</strong></p>
<p>id<br>select查询的序列号</p>
<p>select_type<br>select查询的类型，主要是区别普通查询和联合查询、子查询之类的复杂查询。</p>
<p>table<br>输出的行所引用的表。</p>
<p>type<br>联合查询所使用的类型。<br>type显示的是访问类型，是较为重要的一个指标，结果值从好到坏依次是：<br>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL<br>一般来说，得保证查询至少达到range级别，最好能达到ref。</p>
<p>possible_keys<br>指出MySQL能使用哪个索引在该表中找到行。如果是空的，没有相关的索引。这时要提高性能，可通过检验WHERE子句，看是否引用某些字段，或者检查字段不是适合索引。</p>
<p>key<br>显示MySQL实际决定使用的键。如果没有索引被选择，键是NULL。</p>
<p>key_len<br>显示MySQL决定使用的键长度。如果键是NULL，长度就是NULL。文档提示特别注意这个值可以得出一个多重主键里mysql实际使用了哪一部分。</p>
<p>ref<br>显示哪个字段或常数与key一起被使用。</p>
<p>rows<br>这个数表示mysql要遍历多少数据才能找到，在innodb上是不准确的。</p>
<p>Extra<br>如果是Only index，这意味着信息只用索引树中的信息检索出的，这比扫描整个表要快。<br>如果是where used，就是使用上了where限制。<br>如果是impossible where 表示用不着where，一般就是没查出来啥。<br>如果此信息显示Using filesort或者Using temporary的话会很吃力，WHERE和ORDER BY的索引经常无法兼顾，如果按照WHERE来确定索引，那么在ORDER BY时，就必然会引起Using filesort，这就要看是先过滤再排序划算，还是先排序再过滤划算。</p>
<p><strong>常见的一些名词解释</strong></p>
<p>Using filesort<br>MySQL需要额外的一次传递，以找出如何按排序顺序检索行。</p>
<p>Using index<br>从只使用索引树中的信息而不需要进一步搜索读取实际的行来检索表中的列信息。</p>
<p>Using temporary<br>为了解决查询，MySQL需要创建一个临时表来容纳结果。</p>
<p>ref<br>对于每个来自于前面的表的行组合，所有有匹配索引值的行将从这张表中读取</p>
<p>ALL<br>完全没有索引的情况，性能非常地差劲。</p>
<p>index<br>与ALL相同，除了只有索引树被扫描。这通常比ALL快，因为索引文件通常比数据文件小。</p>
<p>SIMPLE<br>简单SELECT(不使用UNION或子查询)    </p>

        </div>
        <div class="post-tool">
            <a class="btn-thumbs-up" href="javascript:void(0);" data-cid="52" title="95">
                <i class="fa fa-thumbs-up" aria-hidden="true"></i> 打赏
            </a>
        </div>
        
        <div class="post-tags">标签：
            
            <a href="/tags/MySQL/">MySQL</a>
            
        </div>
        
    </article>
    
    
</div>
<!--<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>->
        </div><!-- end #main-->
    </div><!-- end #body -->
    <footer class="footer">
    <div class="footer-inner">
        <p>
            <!-- 
            <a href="/about"  title="关于本站">关于本站</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            -->
        </p>
        <p>
            <br><center>Yaosine.github.io © 2018 </center>
            <!--，已建立<a href="/timeline" id="siteBuildingTime"></a>天<br/>
            ©2018 -->
        </p>
        

    </div>
</footer>
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script src="/js/InsightSearch.js"></script>
<script src="/js/SimpleCore.js"></script>
</div>
<div class="fixed-btn">
    <a class="btn-gotop" href="javascript:"> <i class="fa fa-angle-up"></i></a>
</div>
<script>
    $(function () {
        SimpleCore.init({
            buildingTime: '09/20/2012',
            current: $('.post-tags').length > 0 ? 'post' : 'archive',
            //snsQRCode: '/images/sns-qrcode.png',
            donateImg: '/images/donate-qr.png',
        });
    });
</script>
</body>
</html>