<!DOCTYPE HTML>
<html class="no-js" lang="zh-CN">
<head>
    <!--[if lte IE 9]>
<meta http-equiv="refresh" content="0;url=https://yaosine.github.io/warn.html">
<![endif]-->
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<meta http-equiv="mobile-agent" content="format=html5; url=https://yaosine.github.io">
<meta name="author" content="Yaosine">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/SimpleStyle.min.css">

<link rel="shortcut icon" href="/images/favicon.png">


<title>php生命周期 - Web架构之路 - The way of Web Architecture</title>

<meta name="keywords" content="">

<meta name="description " content="PHP两种运行模式是WEB模式、CLI模式。无论哪种模式，PHP工作原理都是一样的，作为一种SAPI运行。">
</head>
<body>
<div id="nav">
    <nav class="nav-menu">
        <a class="site-name current" href="/" title="WA">WA</a>
        <a class="site-index current" href="/"><i class="fa fa-home"></i><span>Home</span></a>
        <a href="/archives" title="Archives"><i class="fa fa-area-chart "></i><span>Archives</span></a>
        <a href="/tags" title="Tags"><i class="fa fa-tags"></i><span>Tags</span></a>
        <!-- custom single page of menus -->
        
        
        <a href="/categories/PHP" title="PHP">
            <i class="fa fa-product-hunt"></i>
            <span>PHP</span>
        </a>
        
        
        <a href="/categories/MySQL" title="MySQL">
            <i class="fa fa-maxcdn"></i>
            <span>MySQL</span>
        </a>
        
        
        <a href="/categories/Linux" title="Linux">
            <i class="fa fa-linux"></i>
            <span>Linux</span>
        </a>
        
        
        <a href="/categories/Nginx" title="Nginx">
            <i class="fa fa-server"></i>
            <span>Nginx</span>
        </a>
        
        
        <a href="/categories/NoSQL" title="NoSQL">
            <i class="fa fa-registered"></i>
            <span>NoSQL</span>
        </a>
        
        
        <a href="/categories/Queue" title="Queue">
            <i class="fa fa-quora"></i>
            <span>Queue</span>
        </a>
        
        
        <a href="/categories/ES" title="ES">
            <i class="fa fa-etsy"></i>
            <span>ES</span>
        </a>
        
        
        <a href="/categories/GO" title="GO">
            <i class="fa fa-google"></i>
            <span>GO</span>
        </a>
        
    </nav>
</div>
<div class="nav-user">
    <a class="btn-search" href="#"><i class="fa fa-search"></i></a>
    <a class="btn-read-mode" href="#"><i class="fa fa-sun-o"></i></a>
    <!--<a class="btn-sns-qr" href="javascript:"><i class="fa fa-telegram"></i></a>-->
</div>

<div id="wrapper" class="clearfix">
    <div id="body">
        <div class="main" id="main">
            <div id="cover">
    <div class="cover-img"></div>
    <div class="cover-info">
        
        <h1 class="cover-siteName">Web架构之路</h1>
        <h3 class="cover-siteTitle">The way of Web Architecture</h3>
        <p class="cover-siteDesc">一个关注Web架构技术的IT博客</p>
        <div class="cover-sns">
            
            <div class="btn btn-github">
                <a href="https://github.com/yaosine" target="_blank" title="github" ref="friend">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            
        </div>
    </div>
</div>
            <div class="page-title">
    <ul>
        <li><a href="/">Home</a></li>
        
            
                <li class="active">
                    <a href="/categories/PHP" data-name="PHP">PHP</a>
                </li>
            
                <li class="">
                    <a href="/categories/Linux" data-name="Linux">Linux</a>
                </li>
            
                <li class="">
                    <a href="/categories/MySQL" data-name="MySQL">MySQL</a>
                </li>
            
                <li class="">
                    <a href="/categories/NoSQL" data-name="NoSQL">NoSQL</a>
                </li>
            
                <li class="">
                    <a href="/categories/Nginx" data-name="Nginx">Nginx</a>
                </li>
            
                <li class="">
                    <a href="/categories/Queue" data-name="Queue">Queue</a>
                </li>
            
                <li class="">
                    <a href="/categories/ES" data-name="ES">ES</a>
                </li>
            
                <li class="">
                    <a href="/categories/GO" data-name="GO">GO</a>
                </li>
            
        
        <script>
(function (window) {
    window.INSIGHT_CONFIG = {
        ROOT_URL: '/',
        CONTENT_URL: '',
    };
})(window);
</script>
<!--
<li class="page-search">
    <form id="search" class="search-form">
        <label for="s" class="sr-only">Input Search key Words Here</label>
        <input class="search-field" type="text" name="s" class="text" placeholder="Input Search key Words Here" />
        <button type="submit" class="search-form-submit" title="Search"><i class="fa fa-search"></i></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
</li>
-->
    </ul>
</div>
<div class="main-inner">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <div class="post-header">
            <!--
            <div class="post-author clearfix">
                <a class="avatar fleft" href="" target="_blank">
                    <img width="48" src="" alt="avatar"/>
                </a>
                <p><span class="label">作者</span>
                    <a href="" target="_blank"></a>
                    <span title="最后编辑于2013-01-12">2013-01-12</span>
                </p>
                <p></p>
            </div>
            -->
            <h2 class="post-title">PHP生命周期</h2>
            <div class="post-meta">
                本文发布于：2013-01-12，总共4871个字<!--，您是第<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>位看到它的小伙伴-->
            </div>
        </div>
        <div class="post-content markdown-body">
            <h2 id="1、PHP的运行模式："><a href="#1、PHP的运行模式：" class="headerlink" title="1、PHP的运行模式："></a>1、PHP的运行模式：</h2><p>PHP两种运行模式是WEB模式、CLI模式。无论哪种模式，PHP工作原理都是一样的，作为一种SAPI运行。</p>
<ul>
<li>1)、当我们在终端敲入php这个命令的时候，它使用的是CLI。<br>它就像一个web服务器一样来支持php完成这个请求，请求完成后再重新把控制权交给终端。</li>
<li><p>2)、当使用Apache或者别web服务器作为宿主时，当一个请求到来时，PHP会来支持完成这个请求。一般有：</p>
<p>  多进程(通常编译为apache的模块来处理PHP请求)</p>
<p>  多线程模式</p>
</li>
</ul>
<h2 id="2、一切的开始-SAPI接口"><a href="#2、一切的开始-SAPI接口" class="headerlink" title="2、一切的开始: SAPI接口"></a>2、一切的开始: SAPI接口</h2><p>通常我们编写php Web程序都是通过Apache或者Nginx这类Web服务器来测试脚本. 或者在命令行下通过php程序来执行PHP脚本. 执行完成脚本后，服务器应答，浏览器显示应答信息,或者在命令结束后在标准输出显示内容. 我们很少关心PHP解释器在哪里. 虽然通过Web服务器和命令行程序执行脚本看起来很不一样. 实际上她们的工作是一样的. 命令行程序和Web程序类似, 命令行参数传递给要执行的脚本,相当于通过url 请求一个PHP页面. 脚本戳里完成后返回响应结果,只不过命令行响应的结果是显示在终端上. 脚本执行的开始都是通过SAPI接口进行的. </p>
<ul>
<li>1)、<strong>启动apache</strong></li>
</ul>
<p>当给定的SAPI启动时，例如在对/usr/local/apache/bin/apachectl start的响应中，PHP由初始化其内核子系统开始。在接近启动例程的末尾，它加载每个扩展的代码并调用其模块初始化例程（MINIT）。这使得每个扩展可以初始化内部变量、分配资源、注册资源处理器，以及向ZE注册自己的函数，以便于脚本调用这其中的函数时候ZE知道执行哪些代码。</p>
<ul>
<li>2)、<strong>请求处理初始化</strong></li>
</ul>
<p>接下来，PHP等待SAPI层请求要处理的页面。对于CGI或CLI等SAPI，这将立刻发生且只发生一次。对于Apache、IIS或其他成熟的web服务器SAPI，每次远程用户请求页面时都将发生，因此重复很多次，也可能并发。不管请求如何产生，PHP开始于要求ZE建立脚本的运行环境，然后调用每个扩展的请求初始化（RINIT）函数。RINIT使得扩展有机会设定特定的环境变量，根据请求分配资源，或者执行其他任务，如审核。 session扩展中有个RINIT作用的典型示例，如果启用了session.auto_start选项，RINIT将自动触发用户空间的session_start()函数以及预组装$_SESSION变量。</p>
<ul>
<li>3)、<strong>执行php代码</strong></li>
</ul>
<p>一旦请求被初始化了，ZE开始接管控制权，将PHP脚本翻译成符号，最终形成操作码并逐步运行之。如任一操作码需要调用扩展的函数，ZE将会把参数绑定到该函数，并且临时交出控制权直到函数运行结束。</p>
<ul>
<li>4)、<strong>脚本结束</strong></li>
</ul>
<p>脚本运行结束后，PHP调用每个扩展的请求关闭（RSHUTDOWN）函数以执行最后的清理工作（如将session变量存入磁盘）。接下来，ZE执行清理过程（垃圾收集）－有效地对之前的请求期间用到的每个变量执行unset()。</p>
<ul>
<li>5)、<strong>sapi关闭</strong></li>
</ul>
<p>一旦完成，PHP继续等待SAPI的其他文档请求或者是关闭信号。对于CGI和CLI等SAPI，没有“下一个请求”，所以SAPI立刻开始关闭。关闭期间，PHP再次遍历每个扩展，调用其模块关闭（MSHUTDOWN）函数，并最终关闭自己的内核子系统。</p>
<blockquote>
<p>简要的过程如下：</p>
</blockquote>
<pre><code>1. PHP是随着Apache的启动而运行的；
2. PHP通过mod_php5.so模块和Apache相连（具体说来是SAPI，即服务器应用程序编程接口）；
3. PHP总共有三个模块：内核、Zend引擎、以及扩展层；
4. PHP内核用来处理请求、文件流、错误处理等相关操作；
5. Zend引擎（ZE）用以将源文件转换成机器语言，然后在虚拟机上运行它；
6. 扩展层是一组函数、类库和流，PHP使用它们来执行一些特定的操作。比如，我们需要mysql扩展来连接MySQL数据库；
7. 当ZE执行程序时可能会需要连接若干扩展，这时ZE将控制权交给扩展，等处理完特定任务后再返还；
8. 最后，ZE将程序运行结果返回给PHP内核，它再将结果传送给SAPI层，最终输出到浏览器上。
</code></pre><h2 id="3、PHP的开始和结束阶段"><a href="#3、PHP的开始和结束阶段" class="headerlink" title="3、PHP的开始和结束阶段"></a>3、PHP的开始和结束阶段</h2><p>开始阶段有两个过程：</p>
<p><strong>第一个过程</strong>：apache启动的过程，即在任何请求到达之前就发生。是在整个SAPI生命周期内(例如Apache启动以后的整个生命周期内或者命令行程序整个执行过程中)的开始阶段(MINIT),该阶段只进行一次.。启动Apache后，PHP解释程序也随之启动；<br>PHP调用各个扩展（模块）的MINIT方法，从而使这些扩展切换到可用状态。看看php.ini文件里打开了哪些扩展吧； MINIT的意思是“模块初始化”。各个模块都定义了一组函数、类库等用以处理其他请求。 模块在这个阶段可以进行一些初始化工作,例如注册常量, 定义模块使用的类等等.典型的的模块回调函数MINIT方法如下：</p>
<pre><code>PHP_MINIT_FUNCTION(myphpextension) { /* Initialize functions, classes etc */ }  
{  
    // 注册常量或者类等初始化操作  
    return SUCCESS;   
}  
</code></pre><p>第二个过程<strong>发生在请求阶段</strong>,当一个页面请求发生时.则在每次请求之前都会进行初始化过程(RINIT请求开始).<br>请求到达之后，SAPI层将控制权交给PHP层，PHP初始化本次请求执行脚本所需的环境变量,例如创建一个执行环境,包括保存php运行过程中变量名称和变量值内容的符号表. 以及当前所有的函数以及类等信息的符号表.例如是Session模块的RINIT，如果在php.ini中启用了Session 模块，那在调用该模块的RINIT时就会初始化$_SESSION变量，并将相关内容读入；  然后PHP会调用所有模块RINIT函数,即“请求初始化”。 在这个阶段各个模块也可以执行一些相关的操作, 模块的RINIT函数和MINIT函数类似 ，RINIT方法可以看作是一个准备过程，在程序执行之间就会自动启动。</p>
<pre><code>PHP_RINIT_FUNCTION(myphpextension)  
{  
    // 例如记录请求开始时间  
    // 随后在请求结束的时候记录结束时间.这样我们就能够记录下处理请求所花费的时间了  
    return SUCCESS;   
}  
</code></pre><p><strong>结束阶段分为两个环节</strong>：</p>
<p>请求处理完后就进入了结束阶段, 一般脚本执行到末尾或者通过调用exit()或者die()函数,PHP都将进入结束阶段. 和开始阶段对应,结束阶段也分为两个环节,一个在请求结束后(RSHUWDOWN),一个在SAPI生命周期结束时(MSHUTDOWN).</p>
<p><strong>第一个环节</strong>：请求处理完后结束阶段：请求处理完后就进入了结束阶段，PHP就会启动清理程序。它会按顺序调用各个模块的RSHUTDOWN方法。 RSHUTDOWN用以清除程序运行时产生的符号表，也就是对每个变量调用unset函数。典型的RSHUTDOWN方法如下：</p>
<pre><code>PHP_RSHUTDOWN_FUNCTION(myphpextension)  
{  
    // 例如记录请求结束时间, 并把相应的信息写入到日至文件中.  
    return SUCCESS;   
}  
</code></pre><p><strong>第二个环节</strong>：最后，所有的请求都已处理完毕，SAPI也准备关闭了， PHP调用每个扩展的MSHUTDOWN方法，这是各个模块最后一次释放内存的机会。（这个是对于CGI和CLI等SAPI，没有“下一个请求”，所以SAPI立刻开始关闭。）<br>典型的RSHUTDOWN方法如下：</p>
<pre><code>PHP_MSHUTDOWN_FUNCTION(extension_name) {   
    /* Free handlers and persistent memory etc */   
    return SUCCESS;   
} 
</code></pre><p>这样，整个PHP生命周期就结束了。要注意的是，只有在服务器没有请求的情况下才会执行“启动第一步”和“关闭第二步”。</p>
<blockquote>
<p>SAPI运行PHP都经过下面几个阶段:</p>
</blockquote>
<pre><code>1、模块初始化阶段(Module init)     ：
    即调用每个拓展源码中的的PHP_MINIT_FUNCTION中的方法初始化模块,进行一些模块所需变量的申请,内存分配等。
 2、请求初始化阶段(Request init)  ：
    即接受到客户端的请求后调用每个拓展的PHP_RINIT_FUNCTION中的方法,初始化PHP脚本的执行环境。
 3、执行PHP脚本
 4、请求结束(Request Shutdown) ：
   这时候调用每个拓展的PHP_RSHUTDOWN_FUNCTION方法清理请求现场,并且ZE开始回收变量和内存。
 5、关闭模块(Module shutdown)     ：
    Web服务器退出或者命令行脚本执行完毕退出会调用拓展源码中的PHP_MSHUTDOWN_FUNCTION 方法
</code></pre><h2 id="4、单进程SAPI生命周期"><a href="#4、单进程SAPI生命周期" class="headerlink" title="4、单进程SAPI生命周期"></a>4、单进程SAPI生命周期</h2><p>CLI/CGI模式的PHP属于单进程的SAPI模式。这类的请求在处理一次请求后就关闭。也就是只会经过如下几个环节： 开始 - 请求开始 - 请求关闭 - 结束 SAPI接口实现就完成了其生命周期。如图所示：</p>
<p><img src="http://hi.csdn.net/attachment/201203/21/0_13323071462DzD.gif" alt="image"></p>
<h2 id="5、多进程SAPI生命周期"><a href="#5、多进程SAPI生命周期" class="headerlink" title="5、多进程SAPI生命周期"></a>5、多进程SAPI生命周期</h2><p>通常PHP是编译为apache的一个模块来处理PHP请求。Apache一般会采用多进程模式， Apache启动后会<br>fork出多个子进程，每个进程的内存空间独立，每个子进程都会经过开始和结束环节， 不过每个进程的开始阶<br>段只在进程fork出来以来后进行，在整个进程的生命周期内可能会处理多个请求。 只有在Apache关闭或者进程<br>被结束之后才会进行关闭阶段，在这两个阶段之间会随着每个请求重复请求开始-请求关闭的环节。<br>如图所示：</p>
<p><img src="http://hi.csdn.net/attachment/201203/21/0_1332307392MtmH.gif" alt="image"> </p>
<h2 id="6、多线程的SAPI生命周期"><a href="#6、多线程的SAPI生命周期" class="headerlink" title="6、多线程的SAPI生命周期"></a>6、多线程的SAPI生命周期</h2><p>多线程模式和多进程中的某个进程类似，不同的是在整个进程的生命周期内会并行的重复着 请求开始-请求关闭的环节.<br>在这种模式下，只有一个服务器进程在运行着，但会同时运行很多线程，这样可以减少一些资源开销，向Module init和Module shutdown就只需要运行一遍就行了，一些全局变量也只需要初始化一次，因为线程独具的特质，使得各个请求之间方便的共享一些数据成为可能。<br> 多线程工作方式如下图:</p>
<p><img src="http://hi.csdn.net/attachment/201203/21/0_1332307392MtmH.gif" alt="image"></p>
<h2 id="7、Apache一般使用多进程模式prefork"><a href="#7、Apache一般使用多进程模式prefork" class="headerlink" title="7、Apache一般使用多进程模式prefork"></a>7、Apache一般使用多进程模式prefork</h2><p>在linux下使用#http –l 命令可以查看当前使用的工作模式。也可以使用#apachectl -l命令。</p>
<p>看到的prefork.c，说明使用的prefork工作模式。</p>
<p>prefork 进程池模型，用在 UNIX 和类似的系统上比较多，主要是由于写起来方便，也容易移植，还不容易出问题。要知道，如果采用线程模型的话，用户线程、内核线程和混合型线程有不同的特性，移植起来就麻烦。prefork 模型，即预先 fork() 出来一些子进程缓冲一下，用一个锁来控制同步，连接到来了就放行一个子进程，让它去处理。</p>
<p>prefork MPM 使用多个子进程，每个子进程只有一个线程。每个进程在某个确定的时间只能维持一个连接。在大多数平台上，Prefork MPM在效率上要比Worker MPM要高，但是内存使用大得多。prefork的无线程设计在某些情况下将比worker更有优势：他能够使用那些没有处理好线程安全的第三方模块，并 且对于那些线程调试困难的平台而言，他也更容易调试一些。</p>
<p>参考资料：<a href="http://blog.csdn.net/hguisu/article/details/7377520" target="_blank" rel="noopener">http://blog.csdn.net/hguisu/article/details/7377520</a></p>

        </div>
        <div class="post-tool">
            <a class="btn-thumbs-up" href="javascript:void(0);" data-cid="52" title="95">
                <i class="fa fa-thumbs-up" aria-hidden="true"></i> 打赏
            </a>
        </div>
        
        <div class="post-tags">Tags：
            
            <a href="/tags/PHP/">PHP</a>
            
        </div>
        
    </article>
    
    
</div>
<!--<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>->
        </div><!-- end #main-->
    </div><!-- end #body -->
    <footer class="footer">
    <div class="footer-inner">
        <p>
            <!-- 
            <a href="/about"  title="About">About</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            -->
        </p>
        <p>
            <br><center>Yaosine.github.io © 2018 </center>
            <!--，已建立<a href="/timeline" id="siteBuildingTime"></a>天<br/>
            ©2018 -->
        </p>
        

    </div>
</footer>
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script src="/js/InsightSearch.js"></script>
<script src="/js/SimpleCore.js"></script>
</div>
<div class="fixed-btn">
    <a class="btn-gotop" href="javascript:"> <i class="fa fa-angle-up"></i></a>
</div>
<script>
    $(function () {
        SimpleCore.init({
            buildingTime: '09/20/2012',
            current: $('.post-tags').length > 0 ? 'post' : 'archive',
            //snsQRCode: '/images/sns-qrcode.png',
            donateImg: '/images/donate-qr.png',
        });
    });
</script>
</body>
</html>